---
title: "Data_preprocessing"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
---

```{r echo = FALSE, message=FALSE}
# Carregar llibreries
library(car)
library(tables)   # tabular
library(emmeans)  # emmeans
library(car)      # residualPlot
library(RcmdrMisc)#
library(multcomp) # cld 
library(dplyr)
```

```{r echo = FALSE, message=FALSE}
dd    <- read.csv("C:/Users/javil/OneDrive/Documentos/UPC/2n/ME/Proyecto/demographic/demographic.csv") # Llegir
summary(dd)
```
#Description
'RIAGENDR',          # género del participante, factor, 1 hombre 2 mujer
    'RIDAGEYR',          # edad del participante, numerica
    'RIDRETH3',          # raza / etnia, factor 1:Mexican American 2:Other Hispanic 3:Non-Hispanic White 4:Non-Hispanic Black 6:Non-Hispanic Asian 7:Other Race - Including Multi-Racial
    'DMDBORN4',          # país de nacimiento, factor 1:Born in 50 US states or Washington, DC 2:others 77:Refused 99: Don't know
    'DMDCITZN',          # ciudadanía, factor
    'SIALANG',           # idioma de entrevista, factor, 1 english 2 spanish
    'SIAINTRP',          # uso de intérprete, factor 1 yes 2 no
    'DMDFMSIZ',          # tamaño de la familia, numerica discreta
    'DMDHHSZA',          # niños <5, factor 0:none 1:1, 2:2, 3:3 o mas
    'DMDHHSZB',          # niños 6–17, factor 0:none 1:1, 2:2, 3:3, 4:4 o mas
    'DMDHHSZE',          # adultos ≥60, factor, 0:none 1:1, 2:2, 3:3 o mas
    'DMDHRGND',          # género del cabeza de familia, factor 1 hombre 2 mujer
    'DMDHRAGE',          # edad del cabeza de familia, numerica discreta
    'DMDHRBR4',          # país de nacimiento del cabeza, factor 1:Born in 50 US states or Washington, DC 2:others 77:Refused 99: Don't know
    'DMDHREDU',          # educación del cabeza, factor 1:Less than 9th grade 2:9-11th grade (Includes 12th grade with no diploma) 3:High school graduate/GED or equivalent 4:Some college or AA degree 5:College graduate or above 7:refused 9:Don't know
    'DMDHRMAR'           # estado civil del cabeza, factor 1:Married 2:Widowed 3:Divorced 4:Separated 5:Never married 6:Living with partner 77:Refused 99:Don't know
```{r echo = FALSE, message=FALSE}
# Correlaciones para numéricas
num_vars <- dd %>% select_if(is.numeric)
correlations <- sapply(num_vars, function(x) cor(x, dd$INDFMPIR, use = "pairwise.complete.obs"))
sort(correlations, decreasing = TRUE)

# Para categóricas: prueba de ANOVA o Chi-square
anova_result <- aov(INDFMPIR ~ DMDEDUC2, data = dd)
summary(anova_result)
# Instalar y cargar librerías si hace falta
install.packages(c("dplyr", "ggplot2", "tidyr"))
library(dplyr)
library(ggplot2)
library(tidyr)

# Calcular correlaciones con la variable objetivo INDFMPIR
corr_df <- dd %>%
  select_if(is.numeric) %>%
  summarise(across(everything(),
                   ~ cor(.x, dd$INDFMPIR, use = "pairwise.complete.obs"))) %>%
  pivot_longer(cols = everything(),
               names_to = "Variable",
               values_to = "Correlation")

# Ordenar por magnitud
corr_df <- corr_df %>%
  arrange(desc(abs(Correlation)))

# Gráfico de barras
ggplot(corr_df, aes(x = reorder(Variable, Correlation), y = Correlation, fill = Correlation)) +
  geom_col() +
  coord_flip() +
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0) +
  labs(title = "Correlation with INDFMPIR",
       x = "Variable",
       y = "Correlation") +
  theme_minimal()

```
```{r echo = FALSE, message=FALSE}
selected_features <- c(
  'RIAGENDR', 'RIDAGEYR', 'RIDRETH3', 'DMDBORN4', 'DMDCITZN',
  'SIALANG', 'SIAINTRP', 'DMDFMSIZ', 'DMDHHSZA', 'DMDHHSZB',
  'DMDHHSZE', 'DMDHRGND', 'DMDHRAGE', 'DMDHRBR4', 'DMDHREDU',
  'DMDHRMAR', 'INDFMPIR' 
)
dd <- dd[, colnames(dd) %in% selected_features]
summary(dd)
```

```{r echo = FALSE, message=FALSE}


dd$DMDBORN4 <- as.numeric(dd$DMDBORN4)
dd$DMDBORN4[dd$DMDBORN4 %in% c(77,99) | is.na(dd$DMDBORN4)] <- 0
# DMDCITZN: valores existentes [1,2, NA, 7,9]
dd$DMDCITZN <- as.numeric(dd$DMDCITZN)
dd$DMDCITZN[dd$DMDCITZN %in% c(7,9) | is.na(dd$DMDCITZN)] <- 0

# DMDHRBR4: valores existentes [1,2, NA,77]
dd$DMDHRBR4 <- as.numeric(dd$DMDHRBR4)
dd$DMDHRBR4[dd$DMDHRBR4 %in% c(77) | is.na(dd$DMDHRBR4)] <- 0

# DMDHREDU: valores existentes [1,2,3,4,5,NA,7,9]
dd$DMDHREDU <- as.numeric(dd$DMDHREDU)
dd$DMDHREDU[dd$DMDHREDU %in% c(7,9) | is.na(dd$DMDHREDU)] <- 0 

# DMDHRMAR: valores existentes [1,2,3,4,5,6,NA,77,99]
dd$DMDHRMAR <- as.numeric(dd$DMDHRMAR)
dd$DMDHRMAR[dd$DMDHRMAR %in% c(77,99) | is.na(dd$DMDHRMAR)] <- 0  
summary(dd)
```
```{r echo = FALSE, message=FALSE}
factor_vars <- c(
  'RIAGENDR', 'RIDRETH3', 'DMDBORN4', 'DMDCITZN', 
  'SIALANG', 'SIAINTRP', 'DMDHHSZA', 'DMDHHSZB', 
  'DMDHHSZE', 'DMDHRGND', 'DMDHRBR4', 'DMDHREDU', 
  'DMDHRMAR'
)

# Convertir a factor
dd[factor_vars] <- lapply(dd[factor_vars], as.factor)
summary(dd)
```
#there are missing values in target variable

```{r echo = FALSE, message=FALSE}
hist(
  dd$INDFMPIR[!is.na(dd$INDFMPIR)],
  main = "Distribución de INDFMPIR (sin NA)",
  xlab = "INDFMPIR",
  ylab = "Frecuencia",
  col = "lightblue",
  border = "white"
)
```

#the distribution is not normal, as the values are a small percentage of the data we could impute by the median
```{r echo = FALSE, message=FALSE}
dd$INDFMPIR[dd$INDFMPIR <= 0] <- NA

summary(dd)

dd[dd$INDFMPIR <= 0, ]
dd$INDFMPIR[dd$INDFMPIR <= 0] <- NA
dd$INDFMPIR[is.na(dd$INDFMPIR)] <- median(dd$INDFMPIR, na.rm = TRUE)
#there are values that are 0 in the codification, in the NHANES documentation 0 is said to be as missing values, or could not be determined
#we will assume it as missing data
```

```{r echo = FALSE, message=FALSE}
library(RcmdrMisc)
response_var <- "INDFMPIR"
str(dd$INDFMPIR)

par(mfrow=c(1,2))
with(dd, plotMeans(INDFMPIR, SIALANG, SIAINTRP, error.bars="conf.int", level=0.95, connect=TRUE))
with(dd, plotMeans(INDFMPIR, SIAINTRP, SIALANG, error.bars="conf.int", level=0.95, connect=TRUE))
```

#gaussian and identity link is not a good option but we do it to test
```{r echo=FALSE, message=FALSE}

mlgz <- glm(INDFMPIR ~ ., dd, family = gaussian(link=identity))
summary(mlgz)

Anova(mlgz, test.statistic = 'LR')

deviance_residual <- deviance(mlgz)       # devianza residual del modelo
df_residual <- df.residual(mlgz) 

#deviance not good
pearson_chisq <- sum(residuals(mlgz, type = "pearson")^2)
df_resid <- df.residual(mlgz) 

pearson_ratio <- pearson_chisq / df_resid
pearson_ratio


```

```{r echo=FALSE, message=FALSE}
residualPlots(mlgz, layout = c(2,1), ask = FALSE, tests = FALSE)
```
#we can see the line of the model is not good at all, its what we expected

```{r echo=FALSE, message=FALSE}
influencePlot(model = mlgz)
```

#330 is an important outlier
```{r echo=FALSE, message=FALSE}
dd[330, ]
dd[1868, ]
dd[213, ]

```
#the outliers seem to be relevant 

#lets change the family and link function
```{r echo = FALSE, message=FALSE}

mlgz2 <- glm(INDFMPIR ~ ., dd, family = gaussian(link=log))
summary(mlgz2)

Anova(mlgz2, test.statistic = 'LR')

residualPlots(mlgz2, layout = c(2,1), ask = FALSE, tests = FALSE)

```
#improves but not much


```{r echo = FALSE, message=FALSE}

mlgz3 <- glm(INDFMPIR ~ ., dd, family = Gamma(link=log))
summary(mlgz3)

Anova(mlgz3, test.statistic = 'LR')

residualPlots(mlgz3, layout = c(2,1), ask = FALSE, tests = FALSE)

```
